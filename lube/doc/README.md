# 简介

本文说明了一些通用的规则和约定。

文档链接：

[WEB API 手册](web-api.md)
[CARBON 语料格式定义](carbon.json)

## 数据交换

为了简化实现，降低开发成本，所有 API 都使用同样的数据交换方式：

- 接受一个 JSON 类型数据作为请求体
- 返回一个 JSON 类型数据作为响应体

  > 对于二进制数据，使用 BASE64 编码后用 JSON 字符串表示。

- HTTP 请求方法只用 POST
- 使用 URL 作为 API 标识符
- 状态码不包含信息，只返回 200 状态码

  > 只有两种情况例外：
  >
  > 1. 发生严重的、未曾预料的服务器内部错误，返回 500。
  > 2. 请求体无法解析为 JSON 时，会返回 400。
  >
  > 这两种情况发生时，无论是单处理还是批处理，响应体都为空。

这样，前后端交互的所有数据都完全使用 JSON 来表示，可以很方便地扩展到批处理的版本。

所有的 API 都有对应的批处理版本：

- URL 为原 URL 后加上查询字符串 "?batch=1"

  > 例如，原 URL 为 "/corpus/get_content"，则批处理版本为 "/corpus/get_content?batch=1"

- 请求体为原 API 的请求体按序组合成的 JSON 列表，如果不是 JSON 列表，则会响应 400 状态码和空响应体
- 响应体为与请求列表一样长的 JSON 列表，每个元素对应每个请求列表中元素的处理结果
- 调用批处理 API 的语义为按序对请求列表的每个元素处理响应，与直接使用循环进行请求所得的结果等价

### 状态码

为了兼容批处理请求，除两种特殊情况外，JSON API 都只返回 200 作为状态码，
但几乎所有 API 都需要一种标明不同响应情况的机制，
所以在本项目中，使用了一种替代方式来描述处理情况。

- 所有的单处理 API 都会返回一个列表
- 列表的第一项一定为一个整数，标识了处理情况，称为**异常号**
- 列表的长度不固定，但因为异常号的存在，列表至少有 1 个元素
- 小于等于 0 的异常号为全局通用异常号，在所有 API 中出现时的含义都一致，因而不再在文档中列出

以下是全局通用异常号表：

| 异常号 | 说明         | 列表中其它元素（依次列出，为空为不固定） |
| ------ | ------------ | ---------------------------------------- |
| 0      | 成功         |                                          |
| -1     | 未知错误     |
| -10    | 视图层错误   |                                          |
| -11    | 未登录       |                                          |
| -12    | 无权限       | 权限 ID（字符串）                        |
| -13    | 参数无效     |
| -20    | 数据层错误   |
| -21    | 数据类型错误 |
| -22    | 数据格式错误 |
| -23    | 前置状态错误 |

异常描述列表长度不固定，通常在文档中这样描述：

| 情况   | JSON                         |
| ------ | ---------------------------- |
| 成功   | ...                          |
| 异常 1 | \[-1]                        |
| 异常 2 | [-2, 额外消息 1, 额外信息 2] |

## 标识符（ID）约束

ID 用于标识同类中的多个资源实例，在 API 系统中被广泛使用，如"/corpus/id/\<id>"。

由于 URL 格式的定义限制了部分字符的使用，为了避免使用困难，所有 ID 都采用相同的约束规则：

- 使用 Unicode 字符，可以使用中文，甚至可以用 emoji
- 不能为空串
- 长度不能超过 32 个字符
- 不能包含除字母、数字、下划线（\_）、减号（-）、英文句点（.）、波浪号（~）、竖杠（|）以外的 ASCII 符号
- 必须以字母、数字或下划线结尾

> 使用 Python 正则式表示则为："^(\w|[-.~|]){0,31}\w$"
